<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>AI Support Assistant - CIBC Co-Browse</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Open Sans', Arial, sans-serif;
      background: #c41f3e;
      min-height: 100vh;
      color: white;
    }

    /* Header */
    .agent-header {
      background: #a01830;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-logo {
      height: 32px;
    }

    .header-title {
      font-size: 16px;
      font-weight: 600;
    }

    .header-badge {
      background: rgba(255,255,255,0.2);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .session-badge {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 16px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      letter-spacing: 2px;
      display: none;
    }

    .session-badge.show {
      display: block;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: rgba(255,255,255,0.8);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.5);
    }

    .status-dot.connected {
      background: #22c55e;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .logout-btn {
      background: transparent;
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
      font-family: inherit;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.1);
    }

    /* Main Layout */
    .main-layout {
      display: flex;
      height: calc(100vh - 52px);
    }

    /* Auth Panel */
    .auth-panel {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }

    .auth-card {
      background: #fff;
      border-radius: 8px;
      padding: 48px;
      width: 100%;
      max-width: 400px;
      text-align: center;
      color: #333;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .auth-logo {
      margin-bottom: 24px;
    }

    .auth-logo img {
      height: 48px;
    }

    .auth-card h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .auth-card > p {
      color: #666;
      font-size: 14px;
      margin-bottom: 32px;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #333;
      border-radius: 4px;
      font-size: 16px;
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #c41f3e;
      box-shadow: 0 0 0 2px rgba(196, 31, 62, 0.2);
    }

    .login-btn {
      width: 100%;
      background: #c41f3e;
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      font-family: inherit;
      -webkit-appearance: none;
    }

    .login-btn:hover {
      background: #a01830;
    }

    .error-text {
      color: #dc2626;
      font-size: 13px;
      margin-top: 16px;
      display: none;
    }

    .error-text.show {
      display: block;
    }

    /* Setup Panel */
    .setup-panel {
      flex: 1;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }

    .setup-panel.active {
      display: flex;
    }

    .setup-card {
      background: #fff;
      border-radius: 8px;
      padding: 48px;
      width: 100%;
      max-width: 480px;
      text-align: center;
      color: #333;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .setup-icon {
      width: 80px;
      height: 80px;
      background: #c41f3e;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
    }

    .setup-icon svg {
      width: 40px;
      height: 40px;
      color: white;
    }

    .setup-card h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .setup-card > p {
      color: #666;
      font-size: 14px;
      margin-bottom: 32px;
    }

    .setup-section {
      margin-bottom: 24px;
      text-align: left;
    }

    .setup-section label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .code-inputs {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 8px;
    }

    .code-input {
      width: 48px;
      height: 56px;
      background: #fff;
      border: 2px solid #333;
      border-radius: 4px;
      color: #333;
      font-size: 24px;
      font-weight: 600;
      text-align: center;
      font-family: 'Courier New', monospace;
      text-transform: uppercase;
      transition: border-color 0.2s;
    }

    .code-input:focus {
      outline: none;
      border-color: #c41f3e;
      box-shadow: 0 0 0 2px rgba(196, 31, 62, 0.2);
    }

    .api-input {
      width: 100%;
      background: #fff;
      border: 1px solid #333;
      border-radius: 4px;
      color: #333;
      font-size: 14px;
      padding: 12px 14px;
      font-family: 'Courier New', monospace;
      transition: border-color 0.2s;
    }

    .api-input:focus {
      outline: none;
      border-color: #c41f3e;
      box-shadow: 0 0 0 2px rgba(196, 31, 62, 0.2);
    }

    .api-input::placeholder {
      color: #999;
    }

    .api-hint {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }

    .api-hint a {
      color: #c41f3e;
      text-decoration: none;
    }

    .api-hint a:hover {
      text-decoration: underline;
    }

    .connect-btn {
      width: 100%;
      background: #c41f3e;
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 16px;
      font-family: inherit;
      -webkit-appearance: none;
    }

    .connect-btn:hover:not(:disabled) {
      background: #a01830;
    }

    .connect-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Viewer Panel */
    .viewer-panel {
      flex: 1;
      display: none;
      flex-direction: column;
      background: #f5f5f5;
    }

    .viewer-panel.active {
      display: flex;
    }

    /* Split Layout */
    .split-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Screen View */
    .screen-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px;
      min-width: 0;
    }

    .screen-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .screen-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .live-badge {
      background: #22c55e;
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .live-dot {
      width: 6px;
      height: 6px;
      background: white;
      border-radius: 50%;
      animation: pulse 1s infinite;
    }

    .end-btn {
      background: #c41f3e;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      font-family: inherit;
    }

    .end-btn:hover {
      background: #a01830;
    }

    .browser-window {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .browser-bar {
      background: #e5e5e5;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .browser-dots {
      display: flex;
      gap: 6px;
    }

    .browser-dots span {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .browser-dots span:nth-child(1) { background: #ef4444; }
    .browser-dots span:nth-child(2) { background: #f59e0b; }
    .browser-dots span:nth-child(3) { background: #22c55e; }

    .browser-address {
      flex: 1;
      background: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      color: #666;
      border: 1px solid #ddd;
    }

    .browser-viewport {
      flex: 1;
      background: white;
      position: relative;
      overflow: hidden;
    }

    #client-frame {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    .waiting-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .waiting-overlay.hidden {
      display: none;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #eee;
      border-top-color: #c41f3e;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .waiting-text {
      color: #666;
      font-size: 14px;
    }

    /* AI Chat Section */
    .chat-section {
      width: 400px;
      background: white;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 16px 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      gap: 12px;
      background: #c41f3e;
      color: white;
    }

    .ai-avatar {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ai-avatar svg {
      width: 22px;
      height: 22px;
      color: white;
    }

    .ai-info h3 {
      font-size: 14px;
      font-weight: 600;
    }

    .ai-info p {
      font-size: 12px;
      opacity: 0.8;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: #f9f9f9;
    }

    .message {
      max-width: 90%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
    }

    .message.ai {
      background: white;
      color: #333;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      border: 1px solid #ddd;
    }

    .message.user {
      background: #c41f3e;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .message.system {
      background: #f0f0f0;
      color: #666;
      font-size: 12px;
      text-align: center;
      align-self: center;
      padding: 8px 16px;
    }

    .message.thinking {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .thinking-dots {
      display: flex;
      gap: 4px;
    }

    .thinking-dots span {
      width: 8px;
      height: 8px;
      background: #c41f3e;
      border-radius: 50%;
      animation: thinking 1.4s infinite;
    }

    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes thinking {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    /* Voice Controls */
    .voice-controls {
      padding: 20px;
      border-top: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      background: white;
    }

    .mic-button {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: #c41f3e;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .mic-button:hover {
      transform: scale(1.05);
    }

    .mic-button.listening {
      animation: mic-pulse 1.5s infinite;
      box-shadow: 0 0 0 0 rgba(196, 31, 62, 0.7);
    }

    @keyframes mic-pulse {
      0% { box-shadow: 0 0 0 0 rgba(196, 31, 62, 0.7); }
      70% { box-shadow: 0 0 0 20px rgba(196, 31, 62, 0); }
      100% { box-shadow: 0 0 0 0 rgba(196, 31, 62, 0); }
    }

    .mic-button svg {
      width: 28px;
      height: 28px;
      color: white;
    }

    .mic-button.listening svg {
      animation: mic-wave 0.5s infinite alternate;
    }

    @keyframes mic-wave {
      from { transform: scale(1); }
      to { transform: scale(1.1); }
    }

    .voice-hint {
      font-size: 13px;
      color: #666;
    }

    .voice-hint.listening {
      color: #c41f3e;
    }

    /* Transcript */
    .transcript {
      width: 100%;
      min-height: 44px;
      padding: 12px 16px;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 13px;
      color: #666;
      text-align: center;
      border: 1px solid #ddd;
    }

    .transcript.active {
      color: #333;
      border-color: #c41f3e;
    }

    .hidden {
      display: none !important;
    }

    /* Cursor indicator */
    .cursor-indicator {
      position: absolute;
      pointer-events: none;
      z-index: 10000;
      transition: left 0.05s linear, top 0.05s linear;
      display: none;
    }

    .cursor-indicator.show {
      display: block;
    }

    /* Mobile Responsive */
    @media screen and (max-width: 768px) {
      .agent-header {
        flex-direction: column;
        gap: 12px;
        padding: 12px 16px;
      }

      .header-left, .header-right {
        width: 100%;
        justify-content: center;
      }

      .split-container {
        flex-direction: column;
      }

      .chat-section {
        width: 100%;
        height: 300px;
      }

      .auth-panel, .setup-panel {
        padding: 20px;
      }

      .auth-card, .setup-card {
        padding: 32px 24px;
      }

      .code-inputs {
        gap: 6px;
      }

      .code-input {
        width: 40px;
        height: 48px;
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="agent-header">
    <div class="header-left">
      <img src="https://mma.prnewswire.com/media/1632139/CIBC_CIBC_unveils_new_look_symbolizing_the_bank_s_purpose_of_hel.jpg?p=facebook" alt="CIBC" class="header-logo">
      <span class="header-title">AI Support Assistant</span>
      <span class="header-badge">Gemini Vision</span>
    </div>
    <div class="header-right">
      <div class="session-badge" id="sessionBadge">------</div>
      <div class="connection-status">
        <span class="status-dot" id="statusDot"></span>
        <span id="connectionText">Not connected</span>
      </div>
      <button class="logout-btn hidden" id="logoutBtn" onclick="logout()">Logout</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-layout">
    <!-- Auth Panel -->
    <div class="auth-panel" id="authPanel">
      <div class="auth-card">
        <div class="auth-logo">
          <img src="https://mma.prnewswire.com/media/1632139/CIBC_CIBC_unveils_new_look_symbolizing_the_bank_s_purpose_of_hel.jpg?p=facebook" alt="CIBC" style="height: 48px;">
        </div>
        <h2>AI Agent Login</h2>
        <p>Sign in to access the AI co-browse assistant</p>

        <form id="loginForm">
          <div class="form-group">
            <label class="form-label">Username</label>
            <input type="text" class="form-input" id="usernameInput" placeholder="Enter your username" autocomplete="username">
          </div>

          <div class="form-group">
            <label class="form-label">Password</label>
            <input type="password" class="form-input" id="passwordInput" placeholder="Enter your password" autocomplete="current-password">
          </div>

          <button type="submit" class="login-btn" id="loginBtn">Sign In</button>
          <p class="error-text" id="loginErrorText">Invalid username or password</p>
        </form>
      </div>
    </div>

    <!-- Setup Panel -->
    <div class="setup-panel" id="setupPanel">
      <div class="setup-card">
        <div class="setup-icon">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A2.5 2.5 0 0 0 5 15.5 2.5 2.5 0 0 0 7.5 18a2.5 2.5 0 0 0 2.5-2.5A2.5 2.5 0 0 0 7.5 13m9 0a2.5 2.5 0 0 0-2.5 2.5 2.5 2.5 0 0 0 2.5 2.5 2.5 2.5 0 0 0 2.5-2.5 2.5 2.5 0 0 0-2.5-2.5z"/>
          </svg>
        </div>
        <h2>AI Voice Assistant</h2>
        <p>Connect to a customer's screen and help them with voice guidance</p>

        <div class="setup-section">
          <label>Session Code (from customer)</label>
          <div class="code-inputs">
            <input type="text" class="code-input" maxlength="1" data-index="0" placeholder="">
            <input type="text" class="code-input" maxlength="1" data-index="1" placeholder="">
            <input type="text" class="code-input" maxlength="1" data-index="2" placeholder="">
            <input type="text" class="code-input" maxlength="1" data-index="3" placeholder="">
            <input type="text" class="code-input" maxlength="1" data-index="4" placeholder="">
            <input type="text" class="code-input" maxlength="1" data-index="5" placeholder="">
          </div>
        </div>

        <div class="setup-section">
          <label>Gemini API Key</label>
          <input type="password" class="api-input" id="apiKeyInput" placeholder="AIza...">
          <p class="api-hint">Get your free key at <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></p>
        </div>

        <button class="connect-btn" id="connectBtn" disabled>Connect & Start Assistant</button>
        <p class="error-text" id="errorText">Session not found or API key invalid.</p>
      </div>
    </div>

    <!-- Viewer Panel -->
    <div class="viewer-panel" id="viewerPanel">
      <div class="split-container">
        <!-- Screen View -->
        <div class="screen-section">
          <div class="screen-header">
            <div class="screen-title">
              <div class="live-badge">
                <span class="live-dot"></span>
                LIVE
              </div>
              <span style="color: #666; font-size: 13px;">Customer's Screen</span>
            </div>
            <button class="end-btn" onclick="endSession()">End Session</button>
          </div>

          <div class="browser-window">
            <div class="browser-bar">
              <div class="browser-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
              <div class="browser-address">cibc.com/password-reset</div>
            </div>
            <div class="browser-viewport" id="browserViewport">
              <div class="waiting-overlay" id="waitingOverlay">
                <div class="spinner"></div>
                <p class="waiting-text">Waiting for customer's screen...</p>
              </div>
              <iframe id="client-frame" sandbox="allow-same-origin"></iframe>
              <div class="cursor-indicator" id="cursorIndicator">
                <svg width="24" height="24" viewBox="0 0 24 24">
                  <path fill="#c41f3e" stroke="#fff" stroke-width="1.5" d="M5.5 3.21V20.8l5.71-5.71h8.29L5.5 3.21z"/>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- AI Chat -->
        <div class="chat-section">
          <div class="chat-header">
            <div class="ai-avatar">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A2.5 2.5 0 0 0 5 15.5 2.5 2.5 0 0 0 7.5 18a2.5 2.5 0 0 0 2.5-2.5A2.5 2.5 0 0 0 7.5 13m9 0a2.5 2.5 0 0 0-2.5 2.5 2.5 2.5 0 0 0 2.5 2.5 2.5 2.5 0 0 0 2.5-2.5 2.5 2.5 0 0 0-2.5-2.5z"/>
              </svg>
            </div>
            <div class="ai-info">
              <h3>CIBC Assistant</h3>
              <p>Powered by Gemini AI</p>
            </div>
          </div>

          <div class="chat-messages" id="chatMessages">
            <div class="message system">Session connected. Click the microphone and speak to get help.</div>
          </div>

          <div class="voice-controls">
            <div class="transcript" id="transcript">Waiting for customer to speak...</div>
            <p class="voice-hint">Voice controls are on the customer's screen</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ========================================
    // AUTHENTICATION
    // ========================================
    const VALID_USERNAME = 'Ellaite';
    const VALID_PASSWORD = 'Ellaite';
    let agentKey = '';
    let isLoggedIn = false;

    // Check if already logged in
    if (sessionStorage.getItem('agentLoggedIn') === 'true') {
      agentKey = sessionStorage.getItem('agentKey') || '';
      showSetupPanel();
    }

    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const username = document.getElementById('usernameInput').value;
      const password = document.getElementById('passwordInput').value;

      if (username === VALID_USERNAME && password === VALID_PASSWORD) {
        agentKey = 'demo-secret-change-in-production';
        sessionStorage.setItem('agentLoggedIn', 'true');
        sessionStorage.setItem('agentKey', agentKey);
        showSetupPanel();
      } else {
        document.getElementById('loginErrorText').classList.add('show');
      }
    });

    function showSetupPanel() {
      isLoggedIn = true;
      document.getElementById('authPanel').classList.add('hidden');
      document.getElementById('setupPanel').classList.add('active');
      document.getElementById('logoutBtn').classList.remove('hidden');
      codeInputs[0].focus();
    }

    function logout() {
      sessionStorage.removeItem('agentLoggedIn');
      sessionStorage.removeItem('agentKey');
      location.reload();
    }

    // ========================================
    // CONFIGURATION
    // ========================================
    let ws = null;
    let sessionCode = '';
    let apiKey = '';
    let conversationHistory = [];

    const SYSTEM_PROMPT = `You are an expert CIBC phone support agent. You can SEE the customer's screen in real-time.

STRICT RULES:
1. ONLY help with password reset - redirect any other topics
2. Be PRECISE - tell them exactly which field to fill next
3. NEVER guess - only describe what you actually see in the screenshot

SCREEN ANALYSIS - Carefully examine:
1. Which step? Look for "STEP 1 OF 3", "STEP 2 OF 3", or "STEP 3 OF 3"
2. What fields are visible? Card number, expiry date, phone number, verification code boxes, password fields?
3. What's already filled in? What's empty?
4. Is the format CORRECT? Check for errors!
5. Any error messages showing (red text)?

STEP 1 - CARD DETAILS - CHECK FORMATS:
- Card number: Must be exactly 16 digits (shown as XXXX XXXX XXXX XXXX). Located on BACK of card.
- Expiry date: Must be MM/YY format (e.g., 03/25)
- Phone number: Must be 10 digits in format (XXX) XXX-XXXX

STEP 2 - VERIFICATION CODE - CHECK FORMAT:
- Must be exactly 6 digits, one per box
- All boxes must be filled before clicking Verify

STEP 3 - CREATE PASSWORD - CHECK REQUIREMENTS:
- Minimum 16 characters
- Must include: uppercase, lowercase, and number
- Both password fields must match

Respond with clear, concise guidance in 1-2 sentences.`;

    // ========================================
    // SETUP & CONNECTION
    // ========================================
    const codeInputs = document.querySelectorAll('.code-input');

    codeInputs.forEach((input, index) => {
      input.addEventListener('input', (e) => {
        const value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        e.target.value = value;

        if (value && index < codeInputs.length - 1) {
          codeInputs[index + 1].focus();
        }

        updateConnectButton();
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
          codeInputs[index - 1].focus();
        }
      });

      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const pasted = e.clipboardData.getData('text').toUpperCase().replace(/[^A-Z0-9]/g, '');
        pasted.split('').slice(0, 6).forEach((char, i) => {
          if (codeInputs[i]) codeInputs[i].value = char;
        });
        updateConnectButton();
        if (pasted.length >= 6) codeInputs[5].focus();
      });
    });

    document.getElementById('apiKeyInput').addEventListener('input', updateConnectButton);

    function updateConnectButton() {
      const code = Array.from(codeInputs).map(i => i.value).join('');
      const geminiKey = document.getElementById('apiKeyInput').value;
      document.getElementById('connectBtn').disabled = code.length !== 6 || geminiKey.length < 10;
    }

    document.getElementById('connectBtn').addEventListener('click', connect);

    function connect() {
      sessionCode = Array.from(codeInputs).map(i => i.value).join('');
      apiKey = document.getElementById('apiKeyInput').value;
      document.getElementById('errorText').classList.remove('show');

      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}`);

      ws.onopen = () => {
        ws.send(JSON.stringify({
          type: 'join-session',
          code: sessionCode,
          agentKey: agentKey
        }));
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        switch (data.type) {
          case 'session-joined':
            showViewer();
            break;

          case 'error':
            document.getElementById('errorText').textContent = data.message || 'Session not found or invalid credentials.';
            document.getElementById('errorText').classList.add('show');
            break;

          case 'full-page':
            renderClientPage(data.html);
            break;

          case 'cursor-move':
            updateCursor(data.x, data.y);
            break;

          case 'voice-message':
            handleVoiceMessage(data.text);
            break;

          case 'client-disconnected':
          case 'session-ended':
            addMessage('system', 'Customer has disconnected.');
            break;
        }
      };
    }

    async function handleVoiceMessage(text) {
      addMessage('user', text);
      document.getElementById('transcript').textContent = 'Processing: "' + text + '"';

      const thinkingId = addMessage('ai', '<div class="thinking-dots"><span></span><span></span><span></span></div>', true);

      try {
        const screenshot = await captureScreenshot();
        const response = await sendToGemini(text, screenshot);

        removeMessage(thinkingId);
        addMessage('ai', response);

        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'ai-response', text: response }));
        }

      } catch (error) {
        console.error('Error:', error);
        removeMessage(thinkingId);
        const errorMsg = "Sorry, I had a technical issue. Please try again.";
        addMessage('ai', errorMsg + ' (Error: ' + error.message + ')');
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'ai-response', text: errorMsg }));
        }
      }
    }

    function showViewer() {
      document.getElementById('setupPanel').classList.remove('active');
      document.getElementById('viewerPanel').classList.add('active');
      document.getElementById('sessionBadge').textContent = sessionCode;
      document.getElementById('sessionBadge').classList.add('show');
      document.getElementById('statusDot').classList.add('connected');
      document.getElementById('connectionText').textContent = 'Connected';
      addMessage('system', 'Connected! Customer can now speak using their microphone.');
    }

    function renderClientPage(html) {
      document.getElementById('waitingOverlay').classList.add('hidden');
      const iframe = document.getElementById('client-frame');
      iframe.contentDocument.open();
      iframe.contentDocument.write(html);
      iframe.contentDocument.close();

      setTimeout(() => {
        try {
          const doc = iframe.contentDocument;
          doc.querySelectorAll('input, button, select, textarea, a').forEach(el => {
            el.style.pointerEvents = 'none';
          });
        } catch (e) {}
      }, 100);
    }

    function updateCursor(x, y) {
      const cursor = document.getElementById('cursorIndicator');
      const viewport = document.getElementById('browserViewport');
      const scaleX = viewport.clientWidth / window.innerWidth;
      const scaleY = viewport.clientHeight / window.innerHeight;
      cursor.style.left = (x * scaleX) + 'px';
      cursor.style.top = (y * scaleY) + 'px';
      cursor.classList.add('show');
    }

    function endSession() {
      if (ws) {
        ws.send(JSON.stringify({ type: 'end-session' }));
        ws.close();
      }
      location.reload();
    }

    // ========================================
    // AI PROCESSING
    // ========================================

    async function captureScreenshot() {
      const viewport = document.getElementById('browserViewport');
      try {
        const canvas = await html2canvas(viewport, {
          useCORS: true,
          allowTaint: true,
          scale: 0.5
        });
        return canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
      } catch (e) {
        console.error('Screenshot failed:', e);
        return null;
      }
    }

    async function sendToGemini(userMessage, screenshotBase64) {
      conversationHistory.push({ role: 'user', content: userMessage });

      const parts = [];

      if (screenshotBase64) {
        parts.push({
          inlineData: {
            mimeType: 'image/jpeg',
            data: screenshotBase64
          }
        });
      }

      parts.push({ text: SYSTEM_PROMPT + `\n\nCustomer says: "${userMessage}"\n\nAnalyze the screenshot and respond with specific, helpful guidance.` });

      const requestBody = {
        contents: [{ parts: parts }],
        generationConfig: {
          temperature: 0.3,
          maxOutputTokens: 256
        }
      };

      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        }
      );

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error?.message || `API error: ${response.status}`);
      }

      let aiResponse = '';
      const responseParts = data.candidates?.[0]?.content?.parts || [];
      for (const part of responseParts) {
        if (part.text) {
          aiResponse += part.text;
        }
      }

      if (!aiResponse) {
        aiResponse = "I couldn't understand. Please try again.";
      }

      conversationHistory.push({ role: 'assistant', content: aiResponse });
      return aiResponse;
    }

    // ========================================
    // CHAT UI
    // ========================================
    let messageId = 0;

    function addMessage(type, content, isThinking = false) {
      const id = `msg-${++messageId}`;
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.id = id;
      messageDiv.className = `message ${type}${isThinking ? ' thinking' : ''}`;
      messageDiv.innerHTML = content;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      return id;
    }

    function removeMessage(id) {
      const msg = document.getElementById(id);
      if (msg) msg.remove();
    }
  </script>
</body>
</html>
